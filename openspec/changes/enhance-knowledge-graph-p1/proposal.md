# Change: Enhance Knowledge Graph (P1 动态实体关系图谱)

## Why

NewsBox 当前的知识图谱功能已具备基础的实体抽取和可视化能力,但对核心用户(记者/分析师/深度阅读者)而言仍存在关键痛点:

1. **信息孤岛**: 用户看过大量文章,但记不清实体之间的复杂关系网络
2. **记忆模糊**: 难以回忆具体的投资关系、人物关联和时间节点
3. **核查困难**: 写稿时需要确认关系,但缺少快速溯源到原文的能力
4. **缺乏全貌**: 无法看到事件随时间的演变过程和关系变化

当前实现的主要问题:
- **手动触发**: 需要手动点击"重建图谱",用户体验差
- **缺少证据链**: 无法点击关系查看原始出处和证据片段
- **过滤能力弱**: 无法按置信度、关系类型筛选,图谱容易混乱
- **静态展示**: 无法看到关系随时间的建立和演变过程
- **实体重复**: "Musk" 和 "Elon Musk" 被识别为不同实体

本变更将把知识图谱从"技术演示"提升为"生产力工具",让用户能够:
- 自动构建实体关系网络(无需手动触发)
- 点击任意关系查看证据来源
- 通过时间轴回溯事件演变过程
- 使用高级筛选快速定位关键信息

## What Changes

### Product (用户可见功能)

1. **自动实体抽取**
   - 用户收藏内容时自动提取实体和关系
   - 后台异步处理,不阻塞用户操作
   - 自动合并相似实体(如 "Musk" 和 "Elon Musk")

2. **增强的画布交互**
   - 节点大小反映提及频率(高频实体更大)
   - 连线上显示关系类型(如 "投资", "收购", "起诉")
   - 改进的悬停高亮和邻居节点展示

3. **证据溯源系统** (核心差异化功能)
   - 点击任意连线弹出证据模态框
   - 显示提取该关系的原文片段
   - 提供跳转到原始文章的链接
   - 支持多个证据来源(同一关系可能在多篇文章中出现)

4. **高级筛选器**
   - 置信度阈值滑块(隐藏低置信度关系)
   - 实体类型多选(人物/组织/地点/事件/技术/作品)
   - 关系类型筛选(投资/合作/竞争等)
   - 自动过滤泛化实体(如 "记者", "美国" 等无意义节点)

5. **时间轴播放器** (上帝视角)
   - 时间滑块选择查看时间段
   - 播放按钮动态展示关系演变
   - 高亮显示新建立/变化的关系
   - 支持按日期范围筛选

6. **实体档案增强**
   - AI 生成的实体简介(基于库内文章总结)
   - 关系列表显示证据数量
   - 提及时间线(按时间排序的相关文章)
   - 改进的证据链可视化

### Backend (系统能力)

1. **实体抽取管道**
   - 集成到 `/api/capture` 流程
   - 后台任务队列处理(避免阻塞)
   - 实体去重算法(基于余弦相似度)
   - 批量处理历史笔记的 API

2. **时间轴数据模型**
   - 使用 `notes.published_at` 作为关系时间戳
   - 支持按时间范围查询关系
   - 优化时间范围查询性能(添加索引)

3. **AI 实体总结**
   - 复用现有 OpenAI 服务
   - 基于库内提及生成实体简介
   - 缓存生成结果避免重复调用

## Scope

### P1 (本次变更)
- ✅ 自动实体抽取管道(收藏时触发)
- ✅ 实体自动去重(基于相似度)
- ✅ 增强的画布交互(节点大小、关系标签)
- ✅ 证据溯源系统(点击连线查看出处)
- ✅ 高级筛选(置信度、类型、停用词)
- ✅ 时间轴播放器(关系演变可视化)
- ✅ 实体档案增强(AI 简介、时间线)

### Out of Scope (P2/P3)
- ❌ 路径发现(两实体间最短路径) - P2
- ❌ 图谱导出(JSON/GraphML/CSV) - P2
- ❌ 与智能专题集成(专题内图谱) - P2
- ❌ 高级图分析(中心性、社区发现) - P3
- ❌ 手动编辑实体/关系 UI - P3
- ❌ 自定义实体类型和关系类型 - P3

## Impact

### Affected Specs
- `knowledge-base`: 新增知识图谱相关需求(ADDED + MODIFIED)

### Affected Code

**Database**:
- `supabase/migrations/` - 新增索引和约束优化

**Services**:
- `lib/services/knowledge-graph.ts` - 实体去重、停用词过滤
- `lib/services/openai.ts` - 实体摘要生成(复用现有)

**API Routes**:
- `app/api/capture/route.ts` - 集成实体抽取
- `app/api/knowledge/graph/` - 新增时间轴查询端点

**Components**:
- `components/dashboard/knowledge-graph/KnowledgeGraphView.tsx` - 时间轴 UI、筛选器
- `components/dashboard/knowledge-graph/EntityProfilePanel.tsx` - 增强档案
- `components/dashboard/knowledge-graph/EvidenceModal.tsx` - **NEW**: 证据展示
- `components/dashboard/knowledge-graph/TimelineControls.tsx` - **NEW**: 时间轴控制

## Risks / Trade-offs

1. **性能风险**
   - 自动抽取会增加收藏时的处理时间
   - **缓解**: 使用后台任务队列,不阻塞用户操作
   - **缓解**: 添加数据库索引优化查询性能

2. **实体去重准确性**
   - 相似度阈值(0.85)可能导致误合并或漏合并
   - **缓解**: P1 使用保守阈值,P3 提供手动编辑能力
   - **缓解**: 记录合并日志便于调试和回滚

3. **LLM 成本**
   - 每篇文章抽取实体、生成实体摘要会产生 API 调用成本
   - **缓解**: 缓存实体摘要结果
   - **缓解**: 限制每次抽取的文本长度(8000 字符)
   - **缓解**: 批量处理降低请求频率

4. **时间轴数据质量**
   - 依赖 `published_at` 字段,部分文章可能缺失或不准确
   - **缓解**: 使用 `captured_at` 和 `created_at` 作为降级方案
   - **缓解**: 在 UI 中标注时间来源(发布时间 vs 收藏时间)

5. **停用词列表维护**
   - 硬编码的停用词列表可能不适用所有场景
   - **缓解**: P1 使用通用列表,P2 支持用户自定义
   - **缓解**: 提供"显示已过滤实体"开关便于调试

## Success Metrics

- **自动化率**: 90%+ 的新收藏内容自动完成实体抽取
- **证据溯源使用**: 用户点击连线查看证据的频率
- **时间轴使用**: 时间轴播放器的打开率和交互次数
- **筛选使用**: 高级筛选器的使用频率
- **实体去重准确性**: 人工抽查合并结果的准确率 > 85%
