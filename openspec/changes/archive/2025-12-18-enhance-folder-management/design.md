## Context
- 现有 `folders` 仅支持平铺的自定义收藏夹，无法表达父子关系，也缺少与 UI 操作（重命名、设置图标、归档/删除）的契约。
- “我的收藏”侧栏需要一个树状结构，同时在 Supabase 中保持行级安全策略；因此必须在数据层定义 `parent_id`、图标信息、归档标记，并保证计数/过滤逻辑正确。
- 收藏夹操作需要同时作用于数据库（关系、状态）与前端（弹窗、菜单、刷新列表），需要在设计阶段明确 API 行为与异常处理。

## Goals
- 支持多级收藏夹（至少两级），并在 UI 中以缩进/树状呈现。
- 在“收藏夹”标题旁提供 `+` 入口，可创建顶层或指定父级的子收藏夹。
- 为每个收藏夹提供统一的“...”操作菜单：重命名、更换图标、创建子收藏夹、归档、删除。
- 确保点击任意收藏夹后，主列表只展示该节点下的笔记，且路径/选择状态保持一致。

## Non-Goals
- 不实现跨层级拖拽排序（后续迭代再考虑）。
- 不引入自定义上传图标（仅针对内置 icon 枚举或 emoji）。
- 不改变笔记移动/批量操作的既有流程，仅扩展可选的目标列表。

## Decisions
1. **数据模型扩展**
   - `folders` 表新增字段：
     - `parent_id UUID NULL`：自引用 `folders(id)`，`ON DELETE SET NULL`，允许顶层节点 parent 为空。
     - `icon TEXT NULL`：存储内置图标 key 或 emoji，默认 `NULL` 表示使用占位符。
     - `archived_at TIMESTAMPTZ NULL`：标记归档时间；归档后的收藏夹默认从侧栏隐藏，但仍保留层级与内容。
     - （可选）`position INTEGER`：未来支持排序。若已有 `position` 列则复用。
   - 索引：`INDEX ON (user_id, parent_id)`、`INDEX ON (user_id, archived_at)`，便于按父级/归档筛选。
   - 触发器：沿用 `update_updated_at_column` 以保持更新时间。

2. **API / 服务接口**
   - 创建收藏夹：`POST /api/folders` 接受 `name`, `parentId`, `icon`，校验父级必须属于当前用户且未归档。
   - 更新信息：`PATCH /api/folders/:id` 支持 `name`, `icon`.
   - 创建子收藏夹：与创建接口相同，但前端在“...”菜单中预填 parentId。
   - 归档：`POST /api/folders/:id/archive` 设置 `archived_at=now()` 并阻止在导航中显示；可在后续提供恢复端点。
   - 删除：`DELETE /api/folders/:id`，若该文件夹包含笔记或子节点，需返回 409 并提示用户先移动/删除内容，或增加 `force=true` 将子内容移动到父级/未分类（细节在实现阶段确认）。

3. **前端渲染**
   - 采用递归组件渲染树：`folders` API 返回平铺数组后在客户端构建 `children[]`。
   - 选中状态通过 `selectedFolderId` 与路径数组（面包屑）维护；点击子节点时高亮其父链。
   - “+” 按钮弹窗包含名称输入、图标选择器（简单 icon grid）、父级选择（默认顶层）。
   - “...” 菜单 actions：
     - 重命名/更换图标：打开同一对话框，预填当前值。
     - 创建子收藏夹：跳出与 `+` 相同的弹窗但 `parentId` 预设。
     - 归档：确认对话框；归档后在 UI 中淡出并刷新计数。
     - 删除：只有在没有子节点和笔记时可直接删除，否则提示用户移动内容或给予“清空并删除”选项（实现阶段权衡）。

4. **数据联动**
   - 切换收藏夹后调用既有笔记列表 API，传入 `folder_id` 过滤；对父级节点可选择是否包含子级（默认：仅本节点，未来可拓展“包含子级”选项）。
   - 侧栏计数在加载 folders 时同步返回 `note_count`，由 SQL 聚合基于 `folder_id` 计算。

## Risks / Trade-offs
- **深层级性能**：递归/多层树可能导致多次渲染；通过限制层级（建议 3 级）并在 API 层一次性返回即可缓解。
- **删除/归档依赖**：若用户误删带内容的节点，将造成内容丢失；默认禁止删除含内容的收藏夹，并提供归档作为非破坏性替代。
- **同步问题**：多个客户端同时修改同一收藏夹可能造成状态不一致；通过 Supabase Realtime 或刷新侧边栏来缓解，且所有写操作需返回最新版本。

## Migration Plan
1. 编写并部署 `folders` 表迁移，加入新列与索引。
2. 更新 API/服务，确保旧客户端在 `parent_id NULL` 情况下依旧可创建顶层收藏夹。
3. 实现 UI 并与新 API 打通；必要时在功能开关后灰度发布。
4. 手动迁移历史收藏夹（若需要默认图标/排序），并验证多层嵌套、删除/归档流程。

## Open Questions
- 删除包含内容的收藏夹时是否自动将内容移动到父级（或未分类）？抑或强制用户先手动处理？
- 图标选择是否只允许内置 Emoji/线性 icons，还是允许用户上传 SVG？
- 是否需要支持子级计数包含所有后代笔记，而不仅仅是当前层级？

